- name: install yum-utils
  yum:
    name: '{{ YUM_LOCAL_REPO.SRC }}/{{ item }}'
  with_items:
    - '{{ YUM_LOCAL_REPO.YUM_UTILS.RPM_DEPENDENCY }}'
  become: yes
  become_user: root

- include_tasks: task_localrepo_config.yml

- name: install ftp server
  yum:
    name: '{{ YUM_LOCAL_REPO.SRC }}/{{ item }}'
    state: present
  with_items:
    - '{{ YUM_LOCAL_REPO.VSFTPD.RPM_DEPENDENCY }}'
  become: yes

- name: start ftp server
  systemd:
    name: vsftpd
    state: started
    enabled: yes
  become: yes
  become_user: root

- name: copy localrepo files to ftp folder
  copy:
    src: '{{ item }}'
    dest: '{{ YUM_LOCAL_REPO.FTP_FOLDER }}'
    directory_mode: yes
    owner: root
    group: root
    mode: 0744
  with_fileglob:
    - '{{ YUM_LOCAL_REPO.SRC }}'
  become: yes
  become_user: root

- name: create repo
  shell:
    chdir: '{{ YUM_LOCAL_REPO.FTP_FOLDER }}'
    cmd: createrepo .
  become: yes
  become_user: root

- name: open port 21 for ftp
  firewalld:
    port: 21/tcp
    permanent: true
    state: enabled
    service: ftp
  become: yes
  become_user: root

- name: restart firewall
  systemd:
    name: firewalld
    state: restarted
    enabled: yes
  become: yes
  become_user: root
