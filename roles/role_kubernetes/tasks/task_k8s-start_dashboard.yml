- name: copy files to server
  copy:
    src: '{{ role_path }}/files/{{ item }}'
    dest: ~/temp/
    remote_src: false
  become: yes
  become_user: root
  with_items:
    - influxdb.yaml
    - heapster.yaml
    - grafana.yaml
    - heapster-rbac.yaml
    - dashboard-creation.yml
    - dashboard-admin.yaml

- name: start dashboard
  shell: kubectl create -f ~/temp/{{ item }}
  with_items:
    - influxdb.yaml
    - heapster.yaml
    - grafana.yaml
    - heapster-rbac.yaml
    - dashboard-creation.yml
    - dashboard-admin.yaml
  become: yes
  become_user: root

- name: cleanup master
  file:
    path: ~/temp
    state: absent
  become: yes
  become_user: root

- name: stop previous kubeproxy
  shell: kill -9 $(ps aux | grep "kubectl proxy" | awk '{ print $2 }')
  become: yes
  become_user: root
  register: kubeproxy
  failed_when: kubeproxy.rc in []

- name: start kubeproxy
  shell: nohup kubectl proxy --address 131.131.131.100 --port=8001 --accept-hosts='^*$' </dev/null >/dev/null 2>&1 &
  become: yes
  become_user: root
